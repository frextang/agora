<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"/>
		<title>Module agora.node.Ledger</title>
		<link rel="stylesheet" type="text/css" href="../../styles/ddox.css"/>
		<link rel="stylesheet" href="../../prettify/prettify.css" type="text/css"/>
		<script type="text/javascript" src="../../scripts/jquery.js">/**/</script><script type="text/javascript" src="../../scripts/ddox.js">/**/</script>
	</head>
	<body onload="setupDdox();">
		<nav id="main-nav">
			<noscript>
				<p style="color: red">The search functionality needs JavaScript enabled</p>
			</noscript>
			<div id="symbolSearchPane" style="display: none">
				<form action="#" method="GET">
					<input id="symbolSearch" type="text" name="q" placeholder="Search for symbols" autocomplete="off" onchange="performSymbolSearch(40);" onkeypress="this.onchange();" onpaste="this.onchange();" oninput="this.onchange();"/>
				</form>
				<ul id="symbolSearchResults" class="symbolList" style="display: none"></ul><script type="application/javascript" src="../../symbols.js"></script><script type="application/javascript">var symbolSearchRootDir = "../../";
$('#symbolSearchPane').show();</script>
			</div>
			<ul class="tree-view">
				<li class="tree-view ">
					<div class="package ">agora
					</div>
			<ul class="tree-view">
				<li class="tree-view collapsed">
					<div class="package ">api
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/api/FullNode.html">FullNode</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/api/Validator.html">Validator</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">common
					</div>
			<ul class="tree-view">
				<li class="tree-view collapsed">
					<div class="package ">crypto
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/common/crypto/Crc16.html">Crc16</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/crypto/ECC.html">ECC</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/crypto/Key.html">Key</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/crypto/Schnorr.html">Schnorr</a>
					</div>
				</li>
			</ul>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Amount.html">Amount</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/BanManager.html">BanManager</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/BitField.html">BitField</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Config.html">Config</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Hash.html">Hash</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/ManagedDatabase.html">ManagedDatabase</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Metadata.html">Metadata</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/SCPHash.html">SCPHash</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Serializer.html">Serializer</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Set.html">Set</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Task.html">Task</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/TransactionPool.html">TransactionPool</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/common/Types.html">Types</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">consensus
					</div>
			<ul class="tree-view">
				<li class="tree-view collapsed">
					<div class="package ">data
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/consensus/data/Block.html">Block</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/data/ConsensusData.html">ConsensusData</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/data/ConsensusParams.html">ConsensusParams</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/data/Enrollment.html">Enrollment</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/data/PreImageInfo.html">PreImageInfo</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/data/Transaction.html">Transaction</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/data/UTXOSetValue.html">UTXOSetValue</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">protocol
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/consensus/protocol/Nominator.html">Nominator</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">
						<a href="../../agora/consensus/validation.html">validation</a>
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/consensus/validation/Block.html">Block</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/validation/Enrollment.html">Enrollment</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/validation/PreImage.html">PreImage</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/validation/Transaction.html">Transaction</a>
					</div>
				</li>
			</ul>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/EnrollmentManager.html">EnrollmentManager</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/EnrollmentPool.html">EnrollmentPool</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/Genesis.html">Genesis</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/PreImage.html">PreImage</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/Quorum.html">Quorum</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/UTXOSet.html">UTXOSet</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/consensus/ValidatorSet.html">ValidatorSet</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">network
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/network/NetworkClient.html">NetworkClient</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/network/NetworkManager.html">NetworkManager</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view ">
					<div class="package ">node
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/node/BlockStorage.html">BlockStorage</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/node/FullNode.html">FullNode</a>
					</div>
				</li>
				<li>
					<div class="module selected">
						<a href="../../agora/node/Ledger.html">Ledger</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/node/main.html">main</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/node/Runner.html">Runner</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/node/Validator.html">Validator</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">test
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/test/BanManager.html">BanManager</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/Base.html">Base</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/EnrollmentManager.html">EnrollmentManager</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/GenesisBlock.html">GenesisBlock</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/GossipProtocol.html">GossipProtocol</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/Ledger.html">Ledger</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/Metadata.html">Metadata</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/NetworkClient.html">NetworkClient</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/NetworkDiscovery.html">NetworkDiscovery</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/NetworkManager.html">NetworkManager</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/Quorum.html">Quorum</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/Restart.html">Restart</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/test/Simple.html">Simple</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">utils
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../agora/utils/Log.html">Log</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/utils/PrettyPrinter.html">PrettyPrinter</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/utils/SCPPrettyPrinter.html">SCPPrettyPrinter</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/utils/Test.html">Test</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../agora/utils/WellKnownKeys.html">WellKnownKeys</a>
					</div>
				</li>
			</ul>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">scpd
					</div>
			<ul class="tree-view">
				<li class="tree-view collapsed">
					<div class="package ">quorum
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../scpd/quorum/QuorumIntersectionChecker.html">QuorumIntersectionChecker</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/quorum/QuorumTracker.html">QuorumTracker</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">scp
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../scpd/scp/BallotProtocol.html">BallotProtocol</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/scp/LocalNode.html">LocalNode</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/scp/NominationProtocol.html">NominationProtocol</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/scp/QuorumSetUtils.html">QuorumSetUtils</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/scp/SCP.html">SCP</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/scp/SCPDriver.html">SCPDriver</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/scp/Slot.html">Slot</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/scp/Utils.html">Utils</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">tests
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../scpd/tests/GlueTypes.html">GlueTypes</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/tests/LayoutTest.html">LayoutTest</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/tests/SizeTest.html">SizeTest</a>
					</div>
				</li>
			</ul>
				</li>
				<li class="tree-view collapsed">
					<div class="package ">types
					</div>
			<ul class="tree-view">
				<li>
					<div class="module ">
						<a href="../../scpd/types/Stellar_SCP.html">Stellar_SCP</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/types/Stellar_types.html">Stellar_types</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/types/Utils.html">Utils</a>
					</div>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/types/XDRBase.html">XDRBase</a>
					</div>
				</li>
			</ul>
				</li>
				<li>
					<div class="module ">
						<a href="../../scpd/Cpp.html">Cpp</a>
					</div>
				</li>
			</ul>
				</li>
			</ul>
		</nav>
		<div id="main-contents">
			<h1>Module agora.node.Ledger</h1><p>The <code class="lang-d"><a href="../../agora/node/Ledger/Ledger.html"><span class="typ">Ledger</span></a></code> class binds together other components to provide a consistent
    view of the state of the node.
</p><section><p>The Ledger acts as a bridge between other components, e.g. the <code class="lang-d"><span class="typ">UTXOSet</span></code>,
    <code class="lang-d"><span class="typ">EnrollmentManager</span></code>, <code class="lang-d"><span class="typ">IBlockStorage</span></code>, etc...
    While the <code class="lang-d"><span class="typ">Node</span></code> is the main object in Agora, the <code class="lang-d"><a href="../../agora/node/Ledger/Ledger.html"><span class="typ">Ledger</span></a></code> is the second
    most important class, handling all business logic, relying on the the <code class="lang-d"><span class="typ">Node</span></code>
    for anything related to network communicatiion.
</p>
</section>

			<section><section><h2>Example</h2>

<pre class="code"><code class="lang-d"><span class="typ">NodeConfig </span><span class="pln">config </span><span class="pun">= {
    </span><span class="pln">is_validator</span><span class="pun">: </span><span class="kwd">true</span><span class="pun">,
    </span><span class="pln">key_pair</span><span class="pun">:     </span><span class="pln">WK<wbr/></span><span class="pun">.</span><span class="typ">Keys<wbr/></span><span class="pun">.</span><span class="typ">Genesis</span><span class="pun">,
};
</span><span class="kwd">scope </span><span class="pln">ledger </span><span class="pun">= </span><span class="kwd">new </span><span class="typ">TestLedger</span><span class="pun">(</span><span class="pln">config</span><span class="pun">);

</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlockHeight</span><span class="pun">() == </span><span class="lit">0</span><span class="pun">);

</span><span class="kwd">auto </span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">0</span><span class="pun">))<wbr/>.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[$ - </span><span class="lit">1</span><span class="pun">] == </span><span class="typ">GenesisBlock</span><span class="pun">);

</span><span class="typ">Transaction</span><span class="pun">[] </span><span class="pln">last_txs</span><span class="pun">;

</span><span class="com">// generate enough transactions to form a block
</span><span class="typ">void </span><span class="pln">genBlockTransactions </span><span class="pun">(</span><span class="pln">size_t count</span><span class="pun">)
{
    </span><span class="kwd">auto </span><span class="pln">txes </span><span class="pun">= </span><span class="pln">makeChainedTransactions</span><span class="pun">(</span><span class="pln">config<wbr/></span><span class="pun">.</span><span class="pln">key_pair</span><span class="pun">, </span><span class="pln">last_txs</span><span class="pun">, </span><span class="pln">count</span><span class="pun">);

    </span><span class="kwd">foreach </span><span class="pun">(</span><span class="pln">idx</span><span class="pun">, </span><span class="pln">tx</span><span class="pun">; </span><span class="pln">txes</span><span class="pun">)
    {
        </span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">acceptTransaction</span><span class="pun">(</span><span class="pln">tx</span><span class="pun">));
        </span><span class="kwd">if </span><span class="pun">((</span><span class="pln">idx </span><span class="pun">+ </span><span class="lit">1</span><span class="pun">) % </span><span class="typ">Block<wbr/></span><span class="pun">.</span><span class="typ">TxsInBlock </span><span class="pun">== </span><span class="lit">0</span><span class="pun">)
            </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">forceCreateBlock</span><span class="pun">();
    }

    </span><span class="com">// keep track of last tx's to chain them to
    </span><span class="pln">last_txs </span><span class="pun">= </span><span class="pln">txes</span><span class="pun">[$ - </span><span class="typ">Block<wbr/></span><span class="pun">.</span><span class="typ">TxsInBlock </span><span class="pun">.. $];
}

</span><span class="pln">genBlockTransactions</span><span class="pun">(</span><span class="lit">2</span><span class="pun">);
</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">0</span><span class="pun">))<wbr/>.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">] == </span><span class="typ">GenesisBlock</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]<wbr/>.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">0</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">3</span><span class="pun">);  </span><span class="com">// two blocks + genesis block

/// now generate 98 more blocks to make it 100 + genesis block (101 total)
</span><span class="pln">genBlockTransactions</span><span class="pun">(</span><span class="lit">98</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlockHeight</span><span class="pun">() == </span><span class="lit">100</span><span class="pun">);

</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">0</span><span class="pun">))<wbr/>.</span><span class="pln">takeExactly</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">] == </span><span class="typ">GenesisBlock</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]<wbr/>.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">0</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">10</span><span class="pun">);

</span><span class="com">/// lower limit
</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">0</span><span class="pun">))<wbr/>.</span><span class="pln">takeExactly</span><span class="pun">(</span><span class="lit">5</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">] == </span><span class="typ">GenesisBlock</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]<wbr/>.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">0</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">5</span><span class="pun">);

</span><span class="com">/// different indices
</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">1</span><span class="pun">))<wbr/>.</span><span class="pln">takeExactly</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]<wbr/>.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">1</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">10</span><span class="pun">);

</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">50</span><span class="pun">))<wbr/>.</span><span class="pln">takeExactly</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]<wbr/>.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">50</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">10</span><span class="pun">);

</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">95</span><span class="pun">))<wbr/>.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);  </span><span class="com">// only 6 left from here (block 100 included)
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">front<wbr/></span><span class="pun">.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">95</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">walkLength</span><span class="pun">() == </span><span class="lit">6</span><span class="pun">);

</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">99</span><span class="pun">))<wbr/>.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);  </span><span class="com">// only 2 left from here (ditto)
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">front<wbr/></span><span class="pun">.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">99</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">walkLength</span><span class="pun">() == </span><span class="lit">2</span><span class="pun">);

</span><span class="pln">blocks </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">100</span><span class="pun">))<wbr/>.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">);  </span><span class="com">// only 1 block available
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">front<wbr/></span><span class="pun">.</span><span class="pln">header<wbr/></span><span class="pun">.</span><span class="pln">height </span><span class="pun">== </span><span class="lit">100</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">blocks<wbr/></span><span class="pun">.</span><span class="pln">walkLength</span><span class="pun">() == </span><span class="lit">1</span><span class="pun">);

</span><span class="com">// over the limit =&gt; return up to the highest block
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">0</span><span class="pun">))<wbr/>.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">)<wbr/>.</span><span class="pln">walkLength</span><span class="pun">() == </span><span class="lit">101</span><span class="pun">);

</span><span class="com">// higher index than available =&gt; return nothing
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getBlocksFrom</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">1000</span><span class="pun">))<wbr/>.</span><span class="pln">take</span><span class="pun">(</span><span class="lit">10</span><span class="pun">)<wbr/>.</span><span class="pln">walkLength</span><span class="pun">() == </span><span class="lit">0</span><span class="pun">);
</span></code></pre>
</section>
<section><h2>Example</h2>
<p>basic block verification
</p>
<pre class="code"><code class="lang-d"><span class="typ">NodeConfig </span><span class="pln">config </span><span class="pun">= {
    </span><span class="pln">is_validator</span><span class="pun">: </span><span class="kwd">true</span><span class="pun">,
    </span><span class="pln">key_pair</span><span class="pun">:     </span><span class="pln">WK<wbr/></span><span class="pun">.</span><span class="typ">Keys<wbr/></span><span class="pun">.</span><span class="typ">Genesis</span><span class="pun">,
};
</span><span class="kwd">scope </span><span class="pln">ledger </span><span class="pun">= </span><span class="kwd">new </span><span class="typ">TestLedger</span><span class="pun">(</span><span class="pln">config</span><span class="pun">);

</span><span class="typ">Block </span><span class="pln">invalid_block</span><span class="pun">;  </span><span class="com">// default-initialized should be invalid
</span><span class="kwd">assert</span><span class="pun">(!</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">acceptBlock</span><span class="pun">(</span><span class="pln">invalid_block</span><span class="pun">));

</span><span class="kwd">auto </span><span class="pln">txs </span><span class="pun">= </span><span class="pln">makeChainedTransactions</span><span class="pun">(</span><span class="pln">config<wbr/></span><span class="pun">.</span><span class="pln">key_pair</span><span class="pun">, </span><span class="kwd">null</span><span class="pun">, </span><span class="lit">1</span><span class="pun">);

</span><span class="kwd">auto </span><span class="pln">valid_block </span><span class="pun">= </span><span class="pln">makeNewBlock</span><span class="pun">(</span><span class="typ">GenesisBlock</span><span class="pun">, </span><span class="pln">txs</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">acceptBlock</span><span class="pun">(</span><span class="pln">valid_block</span><span class="pun">));
</span></code></pre>
</section>
<section><h2>Example</h2>
<p>Merkle Proof
</p>
<pre class="code"><code class="lang-d"><span class="typ">NodeConfig </span><span class="pln">config </span><span class="pun">= {
    </span><span class="pln">is_validator</span><span class="pun">: </span><span class="kwd">true</span><span class="pun">,
    </span><span class="pln">key_pair</span><span class="pun">:     </span><span class="pln">WK<wbr/></span><span class="pun">.</span><span class="typ">Keys<wbr/></span><span class="pun">.</span><span class="typ">Genesis</span><span class="pun">,
};
</span><span class="kwd">scope </span><span class="pln">ledger </span><span class="pun">= </span><span class="kwd">new </span><span class="typ">TestLedger</span><span class="pun">(</span><span class="pln">config</span><span class="pun">);

</span><span class="kwd">auto </span><span class="pln">txs </span><span class="pun">= </span><span class="pln">makeChainedTransactions</span><span class="pun">(</span><span class="pln">config<wbr/></span><span class="pun">.</span><span class="pln">key_pair</span><span class="pun">, </span><span class="kwd">null</span><span class="pun">, </span><span class="lit">1</span><span class="pun">);
</span><span class="pln">txs<wbr/></span><span class="pun">.</span><span class="pln">each</span><span class="pun">!(</span><span class="pln">tx </span><span class="pun">=&gt; </span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">acceptTransaction</span><span class="pun">(</span><span class="pln">tx</span><span class="pun">)));
</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">forceCreateBlock</span><span class="pun">();

</span><span class="typ">Hash</span><span class="pun">[] </span><span class="pln">hashes</span><span class="pun">;
</span><span class="pln">hashes<wbr/></span><span class="pun">.</span><span class="pln">reserve</span><span class="pun">(</span><span class="pln">txs<wbr/></span><span class="pun">.</span><span class="pln">length</span><span class="pun">);
</span><span class="kwd">foreach </span><span class="pun">(</span><span class="kwd">ref </span><span class="pln">e</span><span class="pun">; </span><span class="pln">txs</span><span class="pun">)
    </span><span class="pln">hashes </span><span class="pun">~= </span><span class="pln">hashFull</span><span class="pun">(</span><span class="pln">e</span><span class="pun">);

</span><span class="com">// transactions are ordered lexicographically by hash in the Merkle tree
</span><span class="pln">hashes<wbr/></span><span class="pun">.</span><span class="pln">sort</span><span class="pun">!(</span><span class="str">"a &lt; b"</span><span class="pun">);

</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">ha </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hb </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">1</span><span class="pun">];
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hc </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">2</span><span class="pun">];
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hd </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">3</span><span class="pun">];
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">he </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">4</span><span class="pun">];
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hf </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">5</span><span class="pun">];
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hg </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">6</span><span class="pun">];
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hh </span><span class="pun">= </span><span class="pln">hashes</span><span class="pun">[</span><span class="lit">7</span><span class="pun">];

</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hab </span><span class="pun">= </span><span class="pln">hashMulti</span><span class="pun">(</span><span class="pln">ha</span><span class="pun">, </span><span class="pln">hb</span><span class="pun">);
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hcd </span><span class="pun">= </span><span class="pln">hashMulti</span><span class="pun">(</span><span class="pln">hc</span><span class="pun">, </span><span class="pln">hd</span><span class="pun">);
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hef </span><span class="pun">= </span><span class="pln">hashMulti</span><span class="pun">(</span><span class="pln">he</span><span class="pun">, </span><span class="pln">hf</span><span class="pun">);
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hgh </span><span class="pun">= </span><span class="pln">hashMulti</span><span class="pun">(</span><span class="pln">hg</span><span class="pun">, </span><span class="pln">hh</span><span class="pun">);

</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">habcd </span><span class="pun">= </span><span class="pln">hashMulti</span><span class="pun">(</span><span class="pln">hab</span><span class="pun">, </span><span class="pln">hcd</span><span class="pun">);
</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">hefgh </span><span class="pun">= </span><span class="pln">hashMulti</span><span class="pun">(</span><span class="pln">hef</span><span class="pun">, </span><span class="pln">hgh</span><span class="pun">);

</span><span class="kwd">const </span><span class="typ">Hash </span><span class="pln">habcdefgh </span><span class="pun">= </span><span class="pln">hashMulti</span><span class="pun">(</span><span class="pln">habcd</span><span class="pun">, </span><span class="pln">hefgh</span><span class="pun">);

</span><span class="typ">Hash</span><span class="pun">[] </span><span class="pln">merkle_path</span><span class="pun">;
</span><span class="pln">merkle_path </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getMerklePath</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">1</span><span class="pun">), </span><span class="pln">hc</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">3</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path</span><span class="pun">[</span><span class="lit">0</span><span class="pun">] == </span><span class="pln">hd</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path</span><span class="pun">[</span><span class="lit">1</span><span class="pun">] == </span><span class="pln">hab</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path</span><span class="pun">[</span><span class="lit">2</span><span class="pun">] == </span><span class="pln">hefgh</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">habcdefgh </span><span class="pun">== </span><span class="typ">Block<wbr/></span><span class="pun">.</span><span class="pln">checkMerklePath</span><span class="pun">(</span><span class="pln">hc</span><span class="pun">, </span><span class="pln">merkle_path</span><span class="pun">, </span><span class="lit">2</span><span class="pun">));
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">habcdefgh </span><span class="pun">!= </span><span class="typ">Block<wbr/></span><span class="pun">.</span><span class="pln">checkMerklePath</span><span class="pun">(</span><span class="pln">hd</span><span class="pun">, </span><span class="pln">merkle_path</span><span class="pun">, </span><span class="lit">2</span><span class="pun">));

</span><span class="pln">merkle_path </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getMerklePath</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">1</span><span class="pun">), </span><span class="pln">he</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">3</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path</span><span class="pun">[</span><span class="lit">0</span><span class="pun">] == </span><span class="pln">hf</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path</span><span class="pun">[</span><span class="lit">1</span><span class="pun">] == </span><span class="pln">hgh</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path</span><span class="pun">[</span><span class="lit">2</span><span class="pun">] == </span><span class="pln">habcd</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">habcdefgh </span><span class="pun">== </span><span class="typ">Block<wbr/></span><span class="pun">.</span><span class="pln">checkMerklePath</span><span class="pun">(</span><span class="pln">he</span><span class="pun">, </span><span class="pln">merkle_path</span><span class="pun">, </span><span class="lit">4</span><span class="pun">));
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">habcdefgh </span><span class="pun">!= </span><span class="typ">Block<wbr/></span><span class="pun">.</span><span class="pln">checkMerklePath</span><span class="pun">(</span><span class="pln">hf</span><span class="pun">, </span><span class="pln">merkle_path</span><span class="pun">, </span><span class="lit">4</span><span class="pun">));

</span><span class="pln">merkle_path </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">getMerklePath</span><span class="pun">(</span><span class="typ">Height</span><span class="pun">(</span><span class="lit">1</span><span class="pun">), </span><span class="typ">Hash<wbr/></span><span class="pun">.</span><span class="pln">init</span><span class="pun">);
</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">merkle_path<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">0</span><span class="pun">);
</span></code></pre>
</section>
<section><h2>Example</h2>
</section>
<section><h2>Situation</h2>
<p>Ledger is constructed with blocks present in storage
</p>
</section>
<section><h2>Expectation</h2>
<p>The UTXOSet is populated with all up-to-date UTXOs
</p>
<pre class="code"><code class="lang-d"><span class="com">// Make a block to put in storage
// TODO: Make this more than one block (e.g. 5)
//       Currently due to the design of `makeChainedTransactions`,
//       we can't do that.
</span><span class="kwd">auto </span><span class="pln">txs </span><span class="pun">= </span><span class="pln">makeChainedTransactions</span><span class="pun">(</span><span class="pln">WK<wbr/></span><span class="pun">.</span><span class="typ">Keys<wbr/></span><span class="pun">.</span><span class="typ">Genesis</span><span class="pun">, </span><span class="kwd">null</span><span class="pun">, </span><span class="lit">1</span><span class="pun">);
</span><span class="com">// Cannot use literals: https://issues.dlang.org/show_bug.cgi?id=20938
</span><span class="kwd">const</span><span class="pun">(</span><span class="typ">Block</span><span class="pun">)[] </span><span class="pln">blocks </span><span class="pun">= [ </span><span class="typ">GenesisBlock</span><span class="pun">() ];
</span><span class="pln">blocks </span><span class="pun">~= </span><span class="pln">makeNewBlock</span><span class="pun">(</span><span class="typ">GenesisBlock</span><span class="pun">, </span><span class="pln">txs</span><span class="pun">);

</span><span class="com">// And provide it to the ledger
</span><span class="typ">NodeConfig </span><span class="pln">config </span><span class="pun">= {
    </span><span class="pln">is_validator</span><span class="pun">: </span><span class="kwd">true</span><span class="pun">,
    </span><span class="pln">key_pair</span><span class="pun">:     </span><span class="pln">WK<wbr/></span><span class="pun">.</span><span class="typ">Keys<wbr/></span><span class="pun">.</span><span class="typ">Genesis</span><span class="pun">,
};
</span><span class="kwd">scope </span><span class="pln">ledger </span><span class="pun">= </span><span class="kwd">new </span><span class="typ">TestLedger</span><span class="pun">(</span><span class="pln">config</span><span class="pun">, </span><span class="pln">blocks</span><span class="pun">);

</span><span class="kwd">assert</span><span class="pun">(</span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">utxo_set<wbr/></span><span class="pun">.</span><span class="pln">length </span><span class="pun">== </span><span class="lit">8</span><span class="pun">);

</span><span class="com">// Ensure that all previously-generated outputs are in the UTXO set
</span><span class="pun">{
    </span><span class="kwd">auto </span><span class="pln">findUTXO </span><span class="pun">= </span><span class="pln">ledger<wbr/></span><span class="pun">.</span><span class="pln">utxo_set<wbr/></span><span class="pun">.</span><span class="pln">getUTXOFinder</span><span class="pun">();
    </span><span class="typ">UTXOSetValue </span><span class="pln">utxo</span><span class="pun">;
    </span><span class="kwd">assert</span><span class="pun">(
        </span><span class="pln">txs<wbr/></span><span class="pun">.</span><span class="pln">all</span><span class="pun">!(
            </span><span class="pln">tx </span><span class="pun">=&gt; </span><span class="pln">iota</span><span class="pun">(</span><span class="pln">tx<wbr/></span><span class="pun">.</span><span class="pln">outputs<wbr/></span><span class="pun">.</span><span class="pln">length</span><span class="pun">)<wbr/>.</span><span class="pln">all</span><span class="pun">!(
                (</span><span class="pln">idx</span><span class="pun">) {
                    </span><span class="kwd">return </span><span class="pln">findUTXO</span><span class="pun">(</span><span class="pln">tx<wbr/></span><span class="pun">.</span><span class="pln">hashFull</span><span class="pun">(), </span><span class="pln">idx</span><span class="pun">, </span><span class="pln">utxo</span><span class="pun">) &amp;&amp;
                        </span><span class="pln">utxo<wbr/></span><span class="pun">.</span><span class="pln">output </span><span class="pun">== </span><span class="pln">tx<wbr/></span><span class="pun">.</span><span class="pln">outputs</span><span class="pun">[</span><span class="pln">idx</span><span class="pun">];
                }
            )
        )
    );
}
</span></code></pre>
</section>
<section><h2>Example</h2>
<p>Test validation of transactions associated with freezing
</p>

<p>Table of freezing status changes over time
</p>
<pre class="code"><code class="lang-d"><span class="pln">freezing status     </span><span class="pun">/ </span><span class="pln">melted     </span><span class="pun">/ </span><span class="pln">frozen     </span><span class="pun">/ </span><span class="pln">melting    </span><span class="pun">/ </span><span class="pln">melted</span></code></pre>
<p>block height        / N1         / N2         / N3         / N4
</p>
<pre class="code"><code class="lang-d"><span class="pln">condition to use    </span><span class="pun">/            / </span><span class="pln">N2 </span><span class="pun">&gt;= </span><span class="pln">N1</span><span class="pun">+</span><span class="lit">1 </span><span class="pun">/ </span><span class="pln">N3 </span><span class="pun">&gt;= </span><span class="pln">N2</span><span class="pun">+</span><span class="lit">1 </span><span class="pun">/ </span><span class="pln">N4 </span><span class="pun">&gt;= </span><span class="pln">N3</span><span class="pun">+</span><span class="lit">2016</span></code></pre>
<p>utxo unlock height  / N1+1       / N2+1       / N3+2016    / N4+1
</p>
<pre class="code"><code class="lang-d"><span class="pln">utxo type           </span><span class="pun">/ </span><span class="typ">Payment    </span><span class="pun">/ </span><span class="typ">Freeze     </span><span class="pun">/ </span><span class="typ">Payment    </span><span class="pun">/ </span><span class="typ">Payment</span></code></pre>
<pre class="code"><code class="lang-d"><span class="typ">NodeConfig </span><span class="pln">config </span><span class="pun">= {</span></code></pre>
</section>
<section><h2>is validator</h2>
<p>true,
</p>
</section>
<section><h2>key pair</h2>
<p>WK.Keys.Genesis,
};
scope ledger = new TestLedger(config);
</p>

<p>KeyPair[] splited_keys = getRandomKeyPairs();
</p>

<p>Transaction[] splited_txex;
</p>

<p>// Divide 8 'Outputs' that are included in Genesis Block by 40,000
// It generates eight addresses and eight transactions,
// and one transaction has eight Outputs with a value of 40,000 values.
void splitGenesis ()
{
    splited_txex = splitGenesisTransaction(splited_keys);
    splited_txex.each!((tx)
    {
        assert(ledger.acceptTransaction(tx));
    });
    ledger.forceCreateBlock();
}
</p>

<p>KeyPair[] in_key_pairs_normal;
KeyPair[] out_key_pairs_normal;
Transaction[] last_txs_normal;
</p>

<p>in_key_pairs_normal.length = 0;
foreach (idx; 0 .. Block.TxsInBlock)
    in_key_pairs_normal ~= splited_keys[0];
</p>

<p>out_key_pairs_normal = getRandomKeyPairs();
</p>

<p>// generate nomal transactions to form a block
void genNormalBlockTransactions (size_t count, bool is_valid = true)
{
    foreach (idx; 0 .. count)
    {
        auto txes = makeTransactionForFreezing (
            in_key_pairs_normal,
            out_key_pairs_normal,
            TxType.Payment,
            last_txs_normal,
            splited_txex[0]);
</p>

<p>        txes.each!((tx)
            {
                assert(ledger.acceptTransaction(tx) == is_valid);
            });
        ledger.forceCreateBlock();
</p>

<p>        if (is_valid)
        {
            // keep track of last tx's to chain them to
            last_txs_normal = txes[$ - Block.TxsInBlock .. $];
</p>

<p>            in_key_pairs_normal = out_key_pairs_normal;
            out_key_pairs_normal = getRandomKeyPairs();
        }
    }
}
</p>

<p>KeyPair[] in_key_pairs_freeze;
KeyPair[] out_key_pairs_freeze;
Transaction[] last_txs_freeze;
</p>

<p>in_key_pairs_freeze.length = 0;
foreach (idx; 0 .. Block.TxsInBlock)
    in_key_pairs_freeze ~= splited_keys[1];
</p>

<p>out_key_pairs_freeze = getRandomKeyPairs();
</p>

<p>// generate freezing transactions to form a block
void genBlockTransactionsFreeze (size_t count, TxType tx_type, bool is_valid = true)
{
    foreach (idx; 0 .. count)
    {
        auto txes = makeTransactionForFreezing (
            in_key_pairs_freeze,
            out_key_pairs_freeze,
            tx_type,
            last_txs_freeze,
            splited_txex[1]);
</p>

<p>        txes.each!((tx)
            {
                assert(ledger.acceptTransaction(tx) == is_valid);
            });
</p>

<p>        if (is_valid)
        {
            ledger.forceCreateBlock();
</p>

<p>            // keep track of last tx's to chain them to
            last_txs_freeze = txes[$ - Block.TxsInBlock .. $];
</p>

<p>            in_key_pairs_freeze = out_key_pairs_freeze;
            out_key_pairs_freeze = getRandomKeyPairs();
        }
    }
}
</p>

<p>// -------------------------------------------------------------------------
// Split Genesis Transaction
// Current height  : 0
// Current Status  : melted
// Expected height : 1
// Expected Status : melted
// Progress        : melted
// -------------------------------------------------------------------------
splitGenesis();
assert(ledger.getBlockHeight() == 1);
</p>

<p>// -------------------------------------------------------------------------
// Create Payment block (Number of transactions Block.TxsInBlock)
// Current height  : 1
// Current Status  : melted
// Expected height : 2
// Expected Status : melted
// Result          : Success
// Progress        : melted
// -------------------------------------------------------------------------
genNormalBlockTransactions(1);
assert(ledger.getBlockHeight() == 2);
</p>

<p>// -------------------------------------------------------------------------
// Creates freezing block (Number of transactions Block.TxsInBlock)
// Current height  : 2
// Current Status  : melted
// Expected height : 3
// Expected Status : frozen
// Result          : Success
// Progress        : melted -&gt; frozen
// -------------------------------------------------------------------------
genBlockTransactionsFreeze(1, TxType.Freeze);
assert(ledger.getBlockHeight() == 3);
</p>

<p>// -------------------------------------------------------------------------
// Creates 7 dummy payment blocks (Number of transactions Block.TxsInBlock * 7)
// Not related to previously frozen UTXO
// Current height  : 3
// Current Status  : frozen
// Expected height : 10
// Expected Status : frozen
// Result          : Success
// Progress        : melted -&gt; frozen
// -------------------------------------------------------------------------
genNormalBlockTransactions(7);
assert(ledger.getBlockHeight() == 10);
</p>

<p>// -------------------------------------------------------------------------
// Creates the payment transaction with frozen UTXO
// Current height  : 10
// Current Status  : frozen
// Expected height : 11
// Expected Status : melting
// Result          : Success
// Progress        : melted -&gt; frozen -&gt; melting
// -------------------------------------------------------------------------
genBlockTransactionsFreeze(1, TxType.Payment);
assert(ledger.getBlockHeight() == 11);
</p>

<p>ulong melting_start = 11;
ulong melting_block_count;
</p>

<p>// -------------------------------------------------------------------------
// Creates the payment transaction with melting UTXO
// Current height  : 11
// Current Status  : melting
// Expected height : 11
// Expected Status : melting
// Result          : Didn't change to melted not yet
// Progress        : melted -&gt; frozen -&gt; melting
// -------------------------------------------------------------------------
genBlockTransactionsFreeze(1, TxType.Payment, false);
assert(ledger.getBlockHeight() == 11);
</p>

<p>// -------------------------------------------------------------------------
// Creates 2014 dummy payment blocks (Number of transactions Block.TxsInBlock * 2014)
// Not related to previously melting UTXO
// Current height  : 11
// Current Status  : melting
// Expected height : 11 + 2014
// Expected Status : melting
// Result          : Success
// Progress        : melted -&gt; frozen -&gt; melting
// -------------------------------------------------------------------------
genNormalBlockTransactions(2014);
assert(ledger.getBlockHeight() == 11 + 2014);
</p>

<p>melting_block_count = ledger.getBlockHeight() - melting_start + 1;
assert(melting_block_count == 2015);
</p>

<p>// -------------------------------------------------------------------------
// Creates the payment transaction with melting UTXO
// Current height  : 11 + 2014
// Current Status  : melting
// Expected height : 11 + 2014
// Expected Status : melting
// Result          : Didn't change to melted not yet
// Progress        : melted -&gt; frozen -&gt; melting
// -------------------------------------------------------------------------
genBlockTransactionsFreeze(1, TxType.Payment, false);
assert(ledger.getBlockHeight() == 11 + 2014);
</p>

<p>// -------------------------------------------------------------------------
// Creates 1 dummy payment block (Number of transactions Block.TxsInBlock)
// Not related to previously melting UTXO
// Current height  : 11 + 2014
// Current Status  : melting
// Expected height : 11 + 2015
// Expected Status : melting
// Result          : Success
// Progress        : melted -&gt; frozen -&gt; melting
// -------------------------------------------------------------------------
genNormalBlockTransactions(1);
assert(ledger.getBlockHeight() == 11 + 2015);
</p>

<p>melting_block_count = ledger.getBlockHeight() - melting_start + 1;
assert(melting_block_count == 2016);
</p>

<p>// -------------------------------------------------------------------------
// Creates the payment transaction with melting UTXO
// Current height  : 11 + 2015
// Current Status  : melting
// Expected height : 11 + 2016
// Expected Status : melted
// Result          : Success, change to melted
// Progress        : melted -&gt; frozen -&gt; melting -&gt; melted
// -------------------------------------------------------------------------
genBlockTransactionsFreeze(1, TxType.Payment);
assert(ledger.getBlockHeight() == 11 + 2016);
</p>

<pre class="code"><code class="lang-d"><span class="pln">
</span><span class="typ">Example</span><span class="pun">:
</span><span class="pln">test enrollments </span><span class="kwd">in </span><span class="pln">the genesis block</span></code></pre>
<p>import agora.common.BitField;
import agora.common.Serializer;
import std.exception;
</p>

<p>// only genesis loaded: validator is active
{
    auto key_pair = KeyPair.random();
    auto params = new immutable(ConsensusParams)();
    scope enroll_man = new EnrollmentManager(":memory:", key_pair, params);
    const blocks = genBlocksToIndex(key_pair, enroll_man, 0);
    scope storage = new MemBlockStorage(blocks);
    scope pool = new TransactionPool(":memory:");
    scope utxo_set = new UTXOSet(":memory:");
    scope config = new Config();
    scope ledger = new Ledger(config.node, params, utxo_set, storage,
                              enroll_man, pool);
    Hash[] keys;
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 1);
}
</p>

<p>// block 1007 loaded: validator is still active
{
    auto validator_cycle = 10;
    auto key_pair = KeyPair.random();
    auto params = new immutable(ConsensusParams)(validator_cycle);
    scope enroll_man = new EnrollmentManager(":memory:", key_pair, params);
    const blocks = genBlocksToIndex(key_pair, enroll_man,
        validator_cycle - 1);
    scope storage = new MemBlockStorage(blocks);
    scope pool = new TransactionPool(":memory:");
    scope utxo_set = new UTXOSet(":memory:");
    scope config = new Config();
    scope ledger = new Ledger(config.node, params, utxo_set, storage,
                              enroll_man, pool);
    Hash[] keys;
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 1);
}
</p>

<p>// block 1008 loaded: validator is inactive
{
    auto validator_cycle = 20;
    auto key_pair = KeyPair.random();
    auto params = new immutable(ConsensusParams)(validator_cycle);
    scope enroll_man = new EnrollmentManager(":memory:", key_pair, params);
    const blocks = genBlocksToIndex(key_pair, enroll_man, validator_cycle);
    scope storage = new MemBlockStorage(blocks);
    scope pool = new TransactionPool(":memory:");
    scope utxo_set = new UTXOSet(":memory:");
    scope config = new Config();
    scope ledger = new Ledger(config.node, params, utxo_set, storage,
                              enroll_man, pool);
    Hash[] keys;
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 0);
}
</p>

<pre class="code"><code class="lang-d"><span class="pln">
</span><span class="typ">Example</span><span class="pun">:
</span><span class="pln">test atomicity of adding blocks and rolling back</span></code></pre>
<p>import agora.common.crypto.Key;
import agora.common.Types;
import agora.common.Hash;
import std.conv;
import std.exception;
import std.range;
</p>

<p>class ThrowingLedger : Ledger
{
    bool throw_in_update_utxo;
    bool throw_in_update_validators;
</p>

<p>    this (NodeConfig node_config, immutable(ConsensusParams) params,
        UTXOSet utxo_set, IBlockStorage storage,
        EnrollmentManager enroll_man, TransactionPool pool,
        void delegate () nothrow @safe onValidatorsChanged = null)
    {
        super(node_config, params, utxo_set, storage, enroll_man, pool,
            onValidatorsChanged);
    }
</p>

<p>    override void updateUTXOSet (const ref Block block) @safe
    {
        super.updateUTXOSet(block);
        if (this.throw_in_update_utxo)
            throw new Exception("");
    }
</p>

<p>    override void updateValidatorSet (const ref Block block) @safe
    {
        super.updateValidatorSet(block);
        if (this.throw_in_update_validators)
            throw new Exception("");
    }
}
</p>

<p>// normal test: UTXO set and Validator set updated
{
    auto key_pair = KeyPair.random();
    auto params = new immutable(ConsensusParams)();
    scope enroll_man = new EnrollmentManager(":memory:", key_pair, params);
    const blocks = genBlocksToIndex(key_pair, enroll_man, 1008);
    assert(blocks.length == 1009);  // +1 for genesis
</p>

<p>    scope storage = new MemBlockStorage(blocks.takeExactly(1008));
    scope pool = new TransactionPool(":memory:");
    scope utxo_set = new UTXOSet(":memory:");
    scope config = new Config();
    scope ledger = new ThrowingLedger(config.node, params, utxo_set,
        storage, enroll_man, pool, null);
    Hash[] keys;
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 1);
    auto utxos = ledger.utxo_set.getUTXOs(WK.Keys.Genesis.address);
    assert(utxos.length == 8);
    utxos.each!(utxo =&gt; assert(utxo.unlock_height == 1008));
</p>

<p>    auto next_block = blocks[$ - 1];
    ledger.addValidatedBlock(next_block);
    assert(ledger.last_block == next_block);
    utxos = ledger.utxo_set.getUTXOs(WK.Keys.Genesis.address);
    assert(utxos.length == 8);
    utxos.each!(utxo =&gt; assert(utxo.unlock_height == 1009));
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 0);
}
</p>

<p>// throws in updateUTXOSet() =&gt; rollback() called, UTXO set reverted,
// Validator set was not modified
{
    auto key_pair = KeyPair.random();
    auto params = new immutable(ConsensusParams)();
    scope enroll_man = new EnrollmentManager(":memory:", key_pair, params);
    const blocks = genBlocksToIndex(key_pair, enroll_man, 1008);
    assert(blocks.length == 1009);  // +1 for genesis
</p>

<p>    scope storage = new MemBlockStorage(blocks.takeExactly(1008));
    scope pool = new TransactionPool(":memory:");
    scope utxo_set = new UTXOSet(":memory:");
    scope config = new Config();
    scope ledger = new ThrowingLedger(config.node, params, utxo_set,
        storage, enroll_man, pool, null);
    Hash[] keys;
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 1);
    auto utxos = ledger.utxo_set.getUTXOs(WK.Keys.Genesis.address);
    assert(utxos.length == 8);
    utxos.each!(utxo =&gt; assert(utxo.unlock_height == 1008));
</p>

<p>    ledger.throw_in_update_utxo = true;
    auto next_block = blocks[$ - 1];
    assertThrown!Exception(ledger.addValidatedBlock(next_block));
    assert(ledger.last_block == blocks[$ - 2]);  // not updated
    utxos = ledger.utxo_set.getUTXOs(WK.Keys.Genesis.address);
    assert(utxos.length == 8);
    utxos.each!(utxo =&gt; assert(utxo.unlock_height == 1008));  // reverted
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 1);  // not updated
}
</p>

<p>// throws in updateValidatorSet() =&gt; rollback() called, UTXO set and
// Validator set reverted
{
    auto key_pair = KeyPair.random();
    auto params = new immutable(ConsensusParams)();
    scope enroll_man = new EnrollmentManager(":memory:", key_pair, params);
    const blocks = genBlocksToIndex(key_pair, enroll_man, 1008);
    assert(blocks.length == 1009);  // +1 for genesis
</p>

<p>    scope storage = new MemBlockStorage(blocks.takeExactly(1008));
    scope pool = new TransactionPool(":memory:");
    scope utxo_set = new UTXOSet(":memory:");
    scope config = new Config();
    scope ledger = new ThrowingLedger(config.node, params, utxo_set,
        storage, enroll_man, pool, null);
    Hash[] keys;
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 1);
    auto utxos = ledger.utxo_set.getUTXOs(WK.Keys.Genesis.address);
    assert(utxos.length == 8);
    utxos.each!(utxo =&gt; assert(utxo.unlock_height == 1008));
</p>

<p>    ledger.throw_in_update_validators = true;
    auto next_block = blocks[$ - 1];
    assertThrown!Exception(ledger.addValidatedBlock(next_block));
    assert(ledger.last_block == blocks[$ - 2]);  // not updated
    utxos = ledger.utxo_set.getUTXOs(WK.Keys.Genesis.address);
    assert(utxos.length == 8);
    utxos.each!(utxo =&gt; assert(utxo.unlock_height == 1008));  // reverted
    assert(enroll_man.getEnrolledUTXOs(keys));
    assert(keys.length == 1);  // reverted
}
</p>

<pre class="code"><code class="lang-d"></code></pre>
</section>
</section>
			<section>
				<h2>Classes</h2>
				<table>
					<col class="caption"/>
					<tr>
						<th>Name</th><th>Description</th>
					</tr>
					<tr>
						<td>
							<code>
								<a id="Ledger" class="public" href="../../agora/node/Ledger/Ledger.html">Ledger</a>
							</code>
						</td>
						<td></td>
					</tr>
				</table>
			</section>
			<footer>
				<table class="license-info">
					<tr>
						<th>Authors</th>
						<td>
							
						</td>
					</tr>
					<tr>
						<th>Copyright</th>
						<td>
							<p>Copyright (c) 2019-2020 BOS Platform Foundation Korea
        All rights reserved.
</p>

						</td>
					</tr>
					<tr>
						<th>License</th>
						<td>
							<p>MIT License. See LICENSE for details.
</p>

						</td>
					</tr>
				</table>
				<p class="faint">Generated using the DDOX documentation generator</p>
			</footer>
		</div>
	</body>
</html>